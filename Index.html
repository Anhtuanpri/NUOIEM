<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Caro Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  text-align:center;
}
#board{
  display:grid;
  gap:4px;
  justify-content:center;
  margin:20px auto;
}
.cell{
  width:26px;
  height:26px;
  background:#1e293b;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:18px;
}
.win{
  background:#16a34a !important;
}
</style>
</head>

<body>

<h2>‚ùå‚≠ï C·ªú CARO ONLINE</h2>
<p id="info"></p>
<div id="board"></div>
<p id="status"></p>

<script>
// ========= FIREBASE =========
firebase.initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6"
});
const db = firebase.database();
// ============================

// ====== C·∫§U H√åNH ======
const SIZE = 15;        // b√†n 15x15
const WIN_COUNT = 5;    // 5 qu√¢n th·∫Øng
// ======================

// room t·ª´ link
let room = location.hash.replace("#","");
if(!room){
  room = Math.random().toString(36).slice(2,7);
  location.hash = room;
}

document.getElementById("info").innerText =
  "Link ph√≤ng: " + location.href;

// x√°c ƒë·ªãnh vai
let myRole = "X";
db.ref("rooms/"+room+"/players").once("value",snap=>{
  if(snap.exists()) myRole = "O";
  db.ref("rooms/"+room+"/players/"+myRole).set(true);
});

// t·∫°o b√†n
const boardDiv = document.getElementById("board");
boardDiv.style.gridTemplateColumns = `repeat(${SIZE}, 26px)`;
let cells = Array(SIZE*SIZE).fill("");

for(let i=0;i<cells.length;i++){
  const d = document.createElement("div");
  d.className = "cell";
  d.onclick = ()=> play(i);
  boardDiv.appendChild(d);
}

// ƒë√°nh c·ªù
function play(i){
  if(cells[i]) return;

  db.ref("rooms/"+room).once("value",snap=>{
    const data = snap.val() || {};
    if(data.winner) return;

    cells[i] = myRole;
    db.ref("rooms/"+room).update({
      board: cells,
      last: myRole
    });
  });
}

// l·∫Øng nghe
db.ref("rooms/"+room).on("value",snap=>{
  const data = snap.val();
  if(!data) return;

  if(data.board){
    cells = data.board;
    cells.forEach((v,i)=>{
      boardDiv.children[i].innerText = v || "";
    });
  }

  if(data.winner){
    document.getElementById("status").innerText =
      `üéâ ${data.winner} TH·∫ÆNG!`;
    highlight(data.winLine);
  }else{
    checkWin();
  }
});

// ki·ªÉm tra th·∫Øng
function checkWin(){
  const dirs = [1, SIZE, SIZE+1, SIZE-1];

  for(let i=0;i<cells.length;i++){
    if(!cells[i]) continue;

    for(let d of dirs){
      let line=[i];
      for(let k=1;k<WIN_COUNT;k++){
        const idx = i + d*k;
        if(cells[idx] === cells[i]) line.push(idx);
        else break;
      }
      if(line.length === WIN_COUNT){
        db.ref("rooms/"+room).update({
          winner: cells[i],
          winLine: line
        });
        return;
      }
    }
  }
}

// t√¥ s√°ng th·∫Øng
function highlight(line){
  line.forEach(i=>{
    boardDiv.children[i].classList.add("win");
  });
}
</script>

</body>
</html>
