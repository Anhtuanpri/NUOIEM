<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù vua Online</title>

<!-- CSS b√†n c·ªù -->
<link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/www/css/chessboard.css">

<!-- üî• jQuery (B·∫ÆT BU·ªòC) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Th∆∞ vi·ªán c·ªù -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://unpkg.com/chessboardjs@1.0.0/www/js/chessboard.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  text-align:center;
}
#board{
  width:320px;
  margin:20px auto;
}
input,button{
  padding:8px;
  margin:5px;
  border:none;
  border-radius:6px;
}
button{
  background:#2563eb;
  color:white;
}
</style>
</head>

<body>

<h2>‚ôüÔ∏è C·ªù vua Online</h2>

<input id="room" placeholder="M√£ ph√≤ng"><br>
<button onclick="createRoom()">T·∫°o ph√≤ng</button>
<button onclick="joinRoom()">V√†o ph√≤ng</button>

<div id="info"></div>
<div id="board"></div>

<button onclick="resetGame()">Reset (Host)</button>

<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6"
});
const db = firebase.database();
/* =========================== */

let game = new Chess();
let board;
let roomId = "";
let myColor = "";
let isHost = false;

/* KH·ªûI T·∫†O B√ÄN C·ªú */
window.onload = () => {
  board = Chessboard("board", {
    draggable: true,
    position: "start",
    onDrop: onDrop
  });
};

/* T·∫†O PH√íNG */
function createRoom(){
  roomId = Math.random().toString(36).slice(2,7);
  document.getElementById("room").value = roomId;

  myColor = "w";
  isHost = true;

  db.ref("rooms/"+roomId).set({
    fen: game.fen()
  });

  listenRoom();
  showInfo();
}

/* V√ÄO PH√íNG */
function joinRoom(){
  roomId = document.getElementById("room").value.trim();
  if(!roomId) return alert("Nh·∫≠p m√£ ph√≤ng");

  myColor = "b";
  listenRoom();
  showInfo();
}

/* HI·ªÇN TH√îNG TIN */
function showInfo(){
  document.getElementById("info").innerText =
    `Ph√≤ng: ${roomId} | B·∫°n: ${myColor==="w"?"Tr·∫Øng":"ƒêen"}`;
}

/* L·∫ÆNG NGHE FIREBASE */
function listenRoom(){
  db.ref("rooms/"+roomId).on("value", snap => {
    if(!snap.val()) return;
    game.load(snap.val().fen);
    board.position(game.fen());
  });
}

/* K√âO TH·∫¢ QU√ÇN */
function onDrop(from, to){
  if(game.turn() !== myColor) return "snapback";

  const move = game.move({
    from: from,
    to: to,
    promotion: "q"
  });

  if(!move) return "snapback";

  db.ref("rooms/"+roomId).update({
    fen: game.fen()
  });
}

/* RESET */
function resetGame(){
  if(!isHost) return alert("Ch·ªâ host reset");

  game.reset();
  db.ref("rooms/"+roomId).set({
    fen: game.fen()
  });
}
</script>

</body>
</html>
