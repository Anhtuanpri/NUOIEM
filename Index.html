<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù Caro Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#0b1020;
  --card:rgba(255,255,255,.08);
  --x:#34d399;
  --o:#f472b6;
}
body{
  margin:0;font-family:system-ui,Arial;color:#fff;text-align:center;
  background:
    radial-gradient(1200px 600px at 10% -10%, #1f2a6a, transparent 40%),
    radial-gradient(1200px 600px at 110% 10%, #0ea5e9, transparent 35%),
    var(--bg);
}
.hidden{display:none}

/* CARD */
#home,#game{
  max-width:560px;margin:20px auto;padding:20px;
  background:var(--card);backdrop-filter:blur(14px);
  border-radius:20px;position:relative;
}

/* INPUT */
input,button{
  padding:10px 12px;margin:6px;border-radius:12px;border:none
}
button{background:#22d3ee;font-weight:600}

/* VERSUS */
#versus{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:10px}
.vs-player{display:flex;flex-direction:column;align-items:center;min-width:100px}
.avatar-wrap{position:relative;width:64px;height:64px;border-radius:50%;overflow:hidden}
.avatar{width:100%;height:100%;object-fit:cover;border-radius:50%}
.frame{position:absolute;inset:-6px;width:76px;height:76px;pointer-events:none}
#sword{font-size:32px}

/* BOARD */
#board{
  display:grid;gap:6px;max-width:520px;margin:12px auto
}
.cell{
  aspect-ratio:1/1;background:#020617;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:clamp(14px,4vw,22px);cursor:pointer
}
.cell.X{color:var(--x)} 
.cell.O{color:var(--o)}

#status{margin-top:10px;font-weight:600}

/* TIMER BOTTOM */
#timers{
  margin-top:14px;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.timer{
  flex:1;
  padding:8px;
  border-radius:10px;
  background:rgba(0,0,0,.4);
  font-weight:700;
}
#turnTimer{color:#facc15}
#matchTimer{color:#60a5fa}
</style>
</head>

<body>

<h2>‚ùå‚≠ï C·ªú CARO ONLINE</h2>

<div id="home">
  <input id="inpName" placeholder="T√™n ki·ªán t∆∞·ªõng"><br>
  <input id="inpAvatar" placeholder="Link avatar"><br>
  <input id="inpRoom" placeholder="M√£ ph√≤ng"><br>
  <button id="btnJoin">V√†o ph√≤ng</button>
</div>

<div id="game" class="hidden">
  <div id="versus">
    <div class="vs-player" id="playerX"></div>
    <div id="sword">‚öîÔ∏è</div>
    <div class="vs-player" id="playerO"></div>
  </div>

  <div id="board"></div>
  <div id="status"></div>

  <!-- TIMER ·ªû D∆Ø·ªöI -->
  <div id="timers">
    <div class="timer" id="turnTimer">‚è± L∆∞·ª£t: ‚Äî</div>
    <div class="timer" id="matchTimer">‚åõ V√°n: 15:00</div>
  </div>
</div>

<script>
/* CONFIG */
const SIZE = 15;
const TURN_LIMIT = 15000;
const MATCH_LIMIT = 15*60*1000;
const FRAME_GIF = "https://i.imgur.com/8Km9tLL.gif";

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL:"https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"noitu-7dca6"
});
const db = firebase.database();

/* DOM */
const home=document.getElementById("home");
const game=document.getElementById("game");
const boardDiv=document.getElementById("board");
const statusEl=document.getElementById("status");
const turnTimerEl=document.getElementById("turnTimer");
const matchTimerEl=document.getElementById("matchTimer");
const pX=document.getElementById("playerX");
const pO=document.getElementById("playerO");

const inpName=document.getElementById("inpName");
const inpAvatar=document.getElementById("inpAvatar");
const inpRoom=document.getElementById("inpRoom");

/* STATE */
let myRole="", roomId="";
let uid=localStorage.uid||(localStorage.uid=Math.random().toString(36));
let timerInt=null;

const savedAvatar=localStorage.getItem("my_avatar");
if(savedAvatar) inpAvatar.value=savedAvatar;

document.getElementById("btnJoin").onclick=joinRoom;

/* JOIN */
function joinRoom(){
  const name=inpName.value.trim();
  const avatar=inpAvatar.value.trim();
  roomId=inpRoom.value.trim();
  if(!name||!roomId) return alert("Nh·∫≠p ƒë·ªß");

  if(avatar) localStorage.setItem("my_avatar",avatar);

  home.classList.add("hidden");
  game.classList.remove("hidden");

  db.ref("rooms/"+roomId).transaction(r=>{
    if(!r){
      r={
        board:Array(SIZE*SIZE).fill(""),
        players:{},
        turn:"X",
        startTime:firebase.database.ServerValue.TIMESTAMP,
        turnTime:firebase.database.ServerValue.TIMESTAMP,
        winner:null
      };
    }

    if(r.players.X && r.players.X.id===uid){ myRole="X"; return r; }
    if(r.players.O && r.players.O.id===uid){ myRole="O"; return r; }

    if(!r.players.X){ r.players.X={name,avatar,id:uid}; myRole="X"; }
    else if(!r.players.O){ r.players.O={name,avatar,id:uid}; myRole="O"; }

    return r;
  });

  listen();
}

/* RENDER */
function renderPlayer(div,p,s){
  if(!p){ div.innerHTML="<strong>???</strong>"; return; }
  div.innerHTML=`
    <div class="avatar-wrap">
      <img class="avatar" src="${p.avatar}">
      <img class="frame" src="${FRAME_GIF}">
    </div>
    <strong style="color:${s==='X'?'var(--x)':'var(--o)'}">${p.name}</strong>`;
}

function renderBoard(board){
  boardDiv.innerHTML="";
  boardDiv.style.gridTemplateColumns=`repeat(${SIZE},1fr)`;
  board.forEach((v,i)=>{
    const d=document.createElement("div");
    d.className="cell "+(v||"");
    d.textContent=v||"";
    d.onclick=()=>play(i);
    boardDiv.appendChild(d);
  });
}

/* TIMER */
function startTimers(r){
  clearInterval(timerInt);

  if(typeof r.startTime!=="number" || typeof r.turnTime!=="number"){
    turnTimerEl.textContent="‚è± L∆∞·ª£t: ‚Äî";
    matchTimerEl.textContent="‚åõ V√°n: 15:00";
    return;
  }

  timerInt=setInterval(()=>{
    if(r.winner){ clearInterval(timerInt); return; }
    const now=Date.now();

    // 15s l∆∞·ª£t
    const left=TURN_LIMIT-(now-r.turnTime);
    if(r.turn===myRole){
      turnTimerEl.textContent="‚è± L∆∞·ª£t: "+Math.max(0,Math.ceil(left/1000))+"s";
    }else{
      turnTimerEl.textContent="‚è± L∆∞·ª£t: ‚Äî";
    }
    if(left<=0){
      db.ref("rooms/"+roomId+"/winner").set(r.turn==="X"?"O":"X");
      clearInterval(timerInt);
      return;
    }

    // 15p v√°n
    const mleft=MATCH_LIMIT-(now-r.startTime);
    const m=Math.max(0,Math.floor(mleft/60000));
    const s=Math.max(0,Math.floor((mleft%60000)/1000));
    matchTimerEl.textContent=`‚åõ V√°n: ${m}:${s.toString().padStart(2,"0")}`;
    if(mleft<=0){
      db.ref("rooms/"+roomId+"/winner").set("draw");
      clearInterval(timerInt);
    }
  },500);
}

/* LISTEN */
function listen(){
  db.ref("rooms/"+roomId).on("value",snap=>{
    const r=snap.val(); if(!r) return;

    renderPlayer(pX,r.players.X,"X");
    renderPlayer(pO,r.players.O,"O");
    renderBoard(r.board);
    startTimers(r);

    if(r.winner){
      statusEl.textContent=r.winner==="draw"?"ü§ù Ho√†":"üèÜ "+r.winner+" th·∫Øng";
    }else{
      statusEl.textContent=r.turn===myRole?"üëâ L∆∞·ª£t c·ªßa b·∫°n":"‚è≥ ƒê·ª£i ƒë·ªëi th·ªß";
    }
  });
}

/* PLAY */
function play(i){
  db.ref("rooms/"+roomId).once("value",snap=>{
    const r=snap.val();
    if(!r||r.turn!==myRole||r.board[i]||r.winner) return;
    r.board[i]=myRole;
    db.ref("rooms/"+roomId).update({
      board:r.board,
      turn:myRole==="X"?"O":"X",
      turnTime:firebase.database.ServerValue.TIMESTAMP
    });
  });
}
</script>

</body>
</html>
