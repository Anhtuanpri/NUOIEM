<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù Caro Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root{
  --bg:#0b1020;
  --card:rgba(255,255,255,.08);
  --x:#34d399;
  --o:#f472b6;
}

body{
  margin:0;
  font-family:system-ui,Arial;
  color:#fff;
  text-align:center;
  background:
    radial-gradient(1200px 600px at 10% -10%, #1f2a6a, transparent 40%),
    radial-gradient(1200px 600px at 110% 10%, #0ea5e9, transparent 35%),
    var(--bg);
}
.hidden{display:none}

/* CARD */
#home,#game{
  max-width:560px;
  margin:20px auto;
  padding:20px;
  background:var(--card);
  backdrop-filter:blur(14px);
  border-radius:20px;
  position:relative;
}

/* INPUT */
input,button{
  padding:10px 12px;
  margin:6px;
  border-radius:12px;
  border:none;
}
input{
  width:80%;
  max-width:400px;
}
button{
  background:#22d3ee;
  font-weight:600;
  cursor:pointer;
}
button:hover{
  background:#06b6d4;
}

.btn-clear{
  background:#ef4444;
  padding:8px 16px;
  font-size:14px;
  margin:10px 5px;
}
.btn-clear:hover{
  background:#dc2626;
}

/* VERSUS */
#versus{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:20px;
  margin-bottom:10px;
}
.vs-player{
  display:flex;
  flex-direction:column;
  align-items:center;
  min-width:100px;
}

/* ===== AVATAR + FRAME (100% CHU·∫®N) ===== */
.avatar-wrap{
  position:relative;
  width:80px;
  height:80px;
  margin-bottom:8px;
}

/* Avatar TR√íN - n·∫±m d∆∞·ªõi */
.avatar-mask{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:64px;
  height:64px;
  border-radius:50%;
  overflow:hidden;
  z-index:1;
  background:#1e293b;
}

.avatar{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  border-radius:50%;
}

/* Khung ƒë·ªông - ƒê√à L√äN TR√äN */
.frame{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  z-index:2;
  pointer-events:none;
  object-fit:contain;
}

#sword{font-size:32px}

/* BOARD */
#board{
  display:grid;
  gap:6px;
  max-width:520px;
  margin:12px auto;
}
.cell{
  aspect-ratio:1/1;
  background:#020617;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:clamp(14px,4vw,22px);
  cursor:pointer;
  transition:all 0.2s;
}
.cell:hover{
  background:#1e293b;
  transform:scale(1.05);
}
.cell.X{color:var(--x);font-weight:bold}
.cell.O{color:var(--o);font-weight:bold}

#status{margin-top:10px;font-weight:600;font-size:18px}

/* TIMER */
#timers{
  margin-top:14px;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.timer{
  flex:1;
  padding:8px;
  border-radius:10px;
  background:rgba(0,0,0,.4);
  font-weight:700;
}
#turnTimer{color:#facc15}
#matchTimer{color:#60a5fa}

/* FILE UPLOAD */
#fileUpload{
  display:none;
}
.upload-btn{
  background:#8b5cf6;
  cursor:pointer;
  display:inline-block;
  padding:10px 20px;
  border-radius:12px;
  margin:10px;
  font-weight:600;
}
.upload-btn:hover{
  background:#7c3aed;
}

/* PREVIEW */
#previewWrap{
  margin:15px auto;
  display:none;
}
#previewAvatar{
  width:80px;
  height:80px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #22d3ee;
}
</style>
</head>

<body>

<h2>‚ùå‚≠ï C·ªú CARO ONLINE</h2>

<div id="home">
  <input id="inpName" placeholder="T√™n ki·ªán t∆∞·ªõng"><br>
  
  <!-- UPLOAD AVATAR -->
  <label for="fileUpload" class="upload-btn">üì∏ Ch·ªçn Avatar</label>
  <input type="file" id="fileUpload" accept="image/*"><br>
  
  <div id="previewWrap">
    <img id="previewAvatar" src="">
    <p style="font-size:12px;color:#22d3ee;">‚úÖ ƒê√£ ch·ªçn ·∫£nh</p>
  </div>
  
  <input id="inpRoom" placeholder="M√£ ph√≤ng"><br>
  
  <button id="btnJoin">üöÄ V√†o ph√≤ng</button><br>
  
  <button class="btn-clear" id="btnClearStorage">üóëÔ∏è X√≥a T·∫•t C·∫£ D·ªØ Li·ªáu C≈©</button>
</div>

<div id="game" class="hidden">
  <div id="versus">
    <div class="vs-player" id="playerX"></div>
    <div id="sword">‚öîÔ∏è</div>
    <div class="vs-player" id="playerO"></div>
  </div>

  <div id="board"></div>
  <div id="status"></div>

  <div id="timers">
    <div class="timer" id="turnTimer">‚è± L∆∞·ª£t: ‚Äî</div>
    <div class="timer" id="matchTimer">‚åõ V√°n: 15:00</div>
  </div>

  <button class="btn-clear" style="margin-top:15px" id="btnLeave">üö™ R·ªùi ph√≤ng</button>
</div>

<script>
/* ===== CONFIG ===== */
const SIZE = 15;
const TURN_LIMIT = 15000;
const MATCH_LIMIT = 15 * 60 * 1000;

/* üëâ D√ÅN LINK KHUNG ƒê·ªòNG T·∫†I ƒê√ÇY */
const FRAME_GIF = "https://i.imgur.com/8Km9tLL.gif";

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL:"https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"noitu-7dca6",
  storageBucket:"noitu-7dca6.firebasestorage.app"
});
const db = firebase.database();
const storage = firebase.storage();

/* ===== DOM ===== */
const home=document.getElementById("home");
const game=document.getElementById("game");
const boardDiv=document.getElementById("board");
const statusEl=document.getElementById("status");
const turnTimerEl=document.getElementById("turnTimer");
const matchTimerEl=document.getElementById("matchTimer");
const pX=document.getElementById("playerX");
const pO=document.getElementById("playerO");

const inpName=document.getElementById("inpName");
const inpRoom=document.getElementById("inpRoom");
const fileUpload=document.getElementById("fileUpload");
const previewWrap=document.getElementById("previewWrap");
const previewAvatar=document.getElementById("previewAvatar");

/* ===== STATE ===== */
let myRole="", roomId="";
let uid=localStorage.uid||(localStorage.uid=Math.random().toString(36));
let timerInt=null;
let selectedFile=null;
let uploadedAvatarURL="";

/* ===== LOAD SAVED DATA ===== */
window.onload = function() {
  const savedName = localStorage.getItem('playerName');
  const savedAvatar = localStorage.getItem('playerAvatar');
  
  if(savedName) inpName.value = savedName;
  if(savedAvatar) {
    uploadedAvatarURL = savedAvatar;
    previewAvatar.src = savedAvatar;
    previewWrap.style.display = 'block';
  }
};

/* ===== FILE UPLOAD ===== */
fileUpload.onchange = function(e){
  selectedFile = e.target.files[0];
  if(!selectedFile) return;
  
  const reader = new FileReader();
  reader.onload = function(evt){
    previewAvatar.src = evt.target.result;
    previewWrap.style.display = 'block';
  };
  reader.readAsDataURL(selectedFile);
};

/* ===== CLEAR ALL STORAGE (LOCAL + FIREBASE) ===== */
document.getElementById("btnClearStorage").onclick = async function() {
  if(!confirm("‚ö†Ô∏è X√ìA T·∫§T C·∫¢:\n- T√™n & ·∫£nh ƒë√£ l∆∞u (localStorage)\n- ·∫¢nh tr√™n Firebase Storage\n\nB·∫°n ch·∫Øc ch·ª©?")) return;
  
  try {
    // 1. X√≥a localStorage
    const oldAvatar = localStorage.getItem('playerAvatar');
    localStorage.removeItem('playerName');
    localStorage.removeItem('playerAvatar');
    
    // 2. X√≥a ·∫£nh tr√™n Firebase Storage (n·∫øu c√≥)
    if(oldAvatar && oldAvatar.includes('firebasestorage')){
      try {
        const ref = storage.refFromURL(oldAvatar);
        await ref.delete();
        console.log('‚úÖ ƒê√£ x√≥a ·∫£nh c≈© tr√™n Storage');
      } catch(err) {
        console.log('‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a ·∫£nh c≈© (c√≥ th·ªÉ ƒë√£ x√≥a r·ªìi):', err);
      }
    }
    
    // 3. Reset UI
    inpName.value = '';
    previewWrap.style.display = 'none';
    previewAvatar.src = '';
    selectedFile = null;
    uploadedAvatarURL = "";
    
    alert("‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu c≈©!");
  } catch(err) {
    alert("‚ùå L·ªói khi x√≥a: " + err.message);
    console.error(err);
  }
};

/* ===== JOIN ===== */
document.getElementById("btnJoin").onclick = async function(){
  const name=inpName.value.trim();
  roomId=inpRoom.value.trim();
  
  if(!name||!roomId) return alert("‚ö†Ô∏è Nh·∫≠p ƒë·ªß t√™n v√† m√£ ph√≤ng!");

  // Upload avatar n·∫øu c√≥ file m·ªõi
  if(selectedFile){
    const fileName = `avatars/${uid}_${Date.now()}.jpg`;
    const storageRef = storage.ref(fileName);
    
    try {
      // X√≥a ·∫£nh c≈© tr∆∞·ªõc (n·∫øu c√≥)
      const oldAvatar = localStorage.getItem('playerAvatar');
      if(oldAvatar && oldAvatar.includes('firebasestorage')){
        try {
          const oldRef = storage.refFromURL(oldAvatar);
          await oldRef.delete();
          console.log('‚úÖ ƒê√£ x√≥a ·∫£nh c≈©');
        } catch(err) {
          console.log('‚ö†Ô∏è ·∫¢nh c≈© kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ x√≥a');
        }
      }
      
      // Upload ·∫£nh m·ªõi
      const snapshot = await storageRef.put(selectedFile);
      uploadedAvatarURL = await snapshot.ref.getDownloadURL();
      console.log('‚úÖ Upload th√†nh c√¥ng:', uploadedAvatarURL);
      
    } catch(err) {
      alert("‚ùå L·ªói upload: " + err.message);
      return;
    }
  }

  // L∆∞u v√†o localStorage
  localStorage.setItem('playerName', name);
  if(uploadedAvatarURL) localStorage.setItem('playerAvatar', uploadedAvatarURL);

  home.classList.add("hidden");
  game.classList.remove("hidden");

  db.ref("rooms/"+roomId).transaction(r=>{
    if(!r){
      r={
        board:Array(SIZE*SIZE).fill(""),
        players:{},
        turn:"X",
        startTime:firebase.database.ServerValue.TIMESTAMP,
        turnTime:firebase.database.ServerValue.TIMESTAMP,
        winner:null
      };
    }

    if(r.players.X && r.players.X.id===uid){ myRole="X"; return r; }
    if(r.players.O && r.players.O.id===uid){ myRole="O"; return r; }

    if(!r.players.X){ 
      r.players.X={name, avatar:uploadedAvatarURL, id:uid}; 
      myRole="X"; 
    }
    else if(!r.players.O){ 
      r.players.O={name, avatar:uploadedAvatarURL, id:uid}; 
      myRole="O"; 
    }

    return r;
  });

  listen();
};

/* ===== LEAVE ROOM ===== */
document.getElementById("btnLeave").onclick = function() {
  if(confirm("R·ªùi ph√≤ng?")){
    clearInterval(timerInt);
    db.ref("rooms/"+roomId).off();
    
    if(myRole){
      db.ref("rooms/"+roomId+"/players/"+myRole).remove();
    }
    
    game.classList.add("hidden");
    home.classList.remove("hidden");
    myRole = "";
    roomId = "";
  }
};

/* ===== RENDER ===== */
function renderPlayer(div,p,s){
  if(!p){ 
    div.innerHTML="<strong>‚ùì Ch·ªù ng∆∞·ªùi ch∆°i...</strong>"; 
    return; 
  }
  
  // Avatar m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥
  const avatarSrc = p.avatar || 'https://i.imgur.com/6VBx3io.png';
  
  div.innerHTML=`
    <div class="avatar-wrap">
      <div class="avatar-mask">
        <img class="avatar" src="${avatarSrc}" onerror="this.src='https://i.imgur.com/6VBx3io.png'">
      </div>
      <img class="frame" src="${FRAME_GIF}">
    </div>
    <strong style="color:${s==="X"?"var(--x)":"var(--o)"}">${p.name}</strong>
  `;
}

function renderBoard(board){
  boardDiv.innerHTML="";
  boardDiv.style.gridTemplateColumns=`repeat(${SIZE},1fr)`;
  board.forEach((v,i)=>{
    const d=document.createElement("div");
    d.className="cell "+(v||"");
    d.textContent=v||"";
    d.onclick=()=>play(i);
    boardDiv.appendChild(d);
  });
}

/* ===== TIMER ===== */
function startTimers(r){
  clearInterval(timerInt);

  if(typeof r.startTime!=="number" || typeof r.turnTime!=="number"){
    turnTimerEl.textContent="‚è± L∆∞·ª£t: ‚Äî";
    matchTimerEl.textContent="‚åõ V√°n: 15:00";
    return;
  }

  timerInt=setInterval(()=>{
    if(r.winner){ 
      clearInterval(timerInt); 
      return; 
    }
    
    const now=Date.now();

    const left=TURN_LIMIT-(now-r.turnTime);
    if(r.turn===myRole){
      const sec = Math.max(0,Math.ceil(left/1000));
      turnTimerEl.textContent="‚è± L∆∞·ª£t: "+sec+"s";
      turnTimerEl.style.color = sec <= 5 ? '#ef4444' : '#facc15';
    }else{
      turnTimerEl.textContent="‚è± ƒê·ª£i ƒë·ªëi th·ªß...";
      turnTimerEl.style.color = '#facc15';
    }

    if(left<=0 && !r.winner){
      db.ref("rooms/"+roomId+"/winner").set(r.turn==="X"?"O":"X");
      clearInterval(timerInt);
      return;
    }

    const mleft=MATCH_LIMIT-(now-r.startTime);
    const m=Math.max(0,Math.floor(mleft/60000));
    const s=Math.max(0,Math.floor((mleft%60000)/1000));
    matchTimerEl.textContent=`‚åõ V√°n: ${m}:${s.toString().padStart(2,"0")}`;

    if(mleft<=0 && !r.winner){
      db.ref("rooms/"+roomId+"/winner").set("draw");
      clearInterval(timerInt);
    }
  },500);
}

/* ===== LISTEN ===== */
function listen(){
  db.ref("rooms/"+roomId).on("value",snap=>{
    const r=snap.val(); 
    if(!r) return;
    
    renderPlayer(pX,r.players.X,"X");
    renderPlayer(pO,r.players.O,"O");
    renderBoard(r.board);
    startTimers(r);

    if(r.winner){
      if(r.winner==="draw"){
        statusEl.textContent = "ü§ù HO√Ä!";
      }else{
        const winnerName = r.players[r.winner]?.name || r.winner;
        statusEl.textContent = `üèÜ ${winnerName} TH·∫ÆNG!`;
      }
    }else{
      statusEl.textContent = r.turn===myRole 
        ? "üëâ L∆Ø·ª¢T C·ª¶A B·∫†N!" 
        : "‚è≥ ƒê·ª£i ƒë·ªëi th·ªß...";
    }
  });
}

/* ===== PLAY ===== */
function play(i){
  db.ref("rooms/"+roomId).once("value",snap=>{
    const r=snap.val();
    if(!r||r.turn!==myRole||r.board[i]||r.winner) return;
    
    r.board[i]=myRole;
    
    if(checkWin(r.board, i)){
      db.ref("rooms/"+roomId).update({
        board:r.board,
        winner:myRole
      });
      return;
    }
    
    if(!r.board.includes("")){
      db.ref("rooms/"+roomId).update({
        board:r.board,
        winner:"draw"
      });
      return;
    }
    
    db.ref("rooms/"+roomId).update({
      board:r.board,
      turn:myRole==="X"?"O":"X",
      turnTime:firebase.database.ServerValue.TIMESTAMP
    });
  });
}

/* ===== CHECK WIN ===== */
function checkWin(board, pos){
  const row = Math.floor(pos/SIZE);
  const col = pos%SIZE;
  const val = board[pos];
  
  const dirs = [
    [0,1], [1,0], [1,1], [1,-1]
  ];
  
  for(let [dr,dc] of dirs){
    let count = 1;
    
    for(let i=1; i<5; i++){
      const r = row + dr*i;
      const c = col + dc*i;
      if(r<0||r>=SIZE||c<0||c>=SIZE) break;
      if(board[r*SIZE+c]!==val) break;
      count++;
    }
    
    for(let i=1; i<5; i++){
      const r = row - dr*i;
      const c = col - dc*i;
      if(r<0||r>=SIZE||c<0||c>=SIZE) break;
      if(board[r*SIZE+c]!==val) break;
      count++;
    }
    
    if(count>=5) return true;
  }
  
  return false;
}
</script>

</body>
</html>
