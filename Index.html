<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù Caro Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{background:#0f172a;color:white;font-family:Arial;text-align:center}
.hidden{display:none}
input,select,button{padding:8px;margin:6px;border-radius:6px;border:none}
#board{display:grid;gap:4px;justify-content:center;margin:20px auto}
.cell{
  width:28px;height:28px;background:#1e293b;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px
}
</style>
</head>

<body>

<h2>‚ùå‚≠ï C·ªú CARO ONLINE</h2>

<!-- TRANG CH·ª¶ -->
<div id="home">
  <input id="name" placeholder="T√™n ki·ªán t∆∞·ªõng"><br>
  <input id="room" placeholder="M√£ ph√≤ng (vd 1111)"><br>
  <select id="size">
    <option value="3">3x3</option>
    <option value="4">4x4</option>
    <option value="5">5x5</option>
    <option value="6">6x6</option>
    <option value="15" selected>15x15</option>
  </select><br>
  <button onclick="joinRoom()">V√†o ph√≤ng</button>
</div>

<!-- GAME -->
<div id="game" class="hidden">
  <p id="info"></p>
  <p id="turn"></p>
  <div id="board"></div>
  <p id="status"></p>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6"
});
const db = firebase.database();
/* =================== */

const TURN_TIME = 15000;

// DOM (B·∫ÆT BU·ªòC)
const nameInput = document.getElementById("name");
const roomInput = document.getElementById("room");
const sizeSelect = document.getElementById("size");
const boardDiv = document.getElementById("board");
const home = document.getElementById("home");
const game = document.getElementById("game");

let SIZE = 15;
let WIN = 5;
let board = [];
let roomId = "";
let myName = "";
let myRole = "spectator";
let uid = localStorage.uid || (localStorage.uid = Math.random().toString(36).slice(2));

function joinRoom(){
  myName = nameInput.value.trim();
  roomId = roomInput.value.trim();
  SIZE = parseInt(sizeSelect.value);
  WIN = SIZE >= 5 ? 5 : SIZE;

  if(!myName || !roomId){
    alert("Nh·∫≠p t√™n v√† m√£ ph√≤ng");
    return;
  }

  home.classList.add("hidden");
  game.classList.remove("hidden");

  db.ref("rooms/"+roomId).transaction(r=>{
    if(!r){
      r={
        size: SIZE,
        win: WIN,
        board: Array(SIZE*SIZE).fill(""),
        players:{},
        turn:"X",
        turnStart: firebase.database.ServerValue.TIMESTAMP
      };
    }

    SIZE = r.size;
    WIN = r.win;
    board = r.board;

    if(!r.players.X){
      r.players.X = {id:uid,name:myName};
      myRole = "X";
    }else if(!r.players.O){
      r.players.O = {id:uid,name:myName};
      myRole = "O";
    }else{
      myRole = "spectator";
    }

    return r;
  });

  listen();
}

function renderBoard(){
  boardDiv.innerHTML = "";
  boardDiv.style.gridTemplateColumns = `repeat(${SIZE},28px)`;

  board.forEach((v,i)=>{
    const d=document.createElement("div");
    d.className="cell";
    d.innerText=v||"";
    d.onclick=()=>play(i);
    boardDiv.appendChild(d);
  });
}

function listen(){
  db.ref("rooms/"+roomId).on("value",snap=>{
    const r=snap.val();
    if(!r) return;

    board = r.board;
    renderBoard();

    document.getElementById("info").innerText =
      `‚ùå ${r.players.X?.name||"..."}  vs  ‚≠ï ${r.players.O?.name||"..."}`;

    if(Date.now() - r.turnStart > TURN_TIME){
      db.ref("rooms/"+roomId).update({
        turn: r.turn==="X"?"O":"X",
        turnStart: firebase.database.ServerValue.TIMESTAMP
      });
    }

    if(r.winner){
      document.getElementById("status").innerText = `üéâ ${r.winner} th·∫Øng`;
      return;
    }

    document.getElementById("turn").innerText =
      r.turn===myRole ? "üëâ L∆∞·ª£t c·ªßa b·∫°n (15s)" : "‚è≥ ƒê·ª£i ƒë·ªëi th·ªß";
  });
}

function play(i){
  if(myRole==="spectator") return;

  db.ref("rooms/"+roomId).once("value",snap=>{
    const r=snap.val();
    if(!r || r.turn!==myRole || r.board[i]) return;

    r.board[i]=myRole;

    db.ref("rooms/"+roomId).update({
      board:r.board,
      turn: myRole==="X"?"O":"X",
      turnStart: firebase.database.ServerValue.TIMESTAMP
    });
  });
}
</script>

</body>
</html>
