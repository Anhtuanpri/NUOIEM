<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù Caro Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  text-align:center;
}
#board{
  display:grid;
  gap:4px;
  justify-content:center;
  margin:20px auto;
}
.cell{
  width:26px;
  height:26px;
  background:#1e293b;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:18px;
}
.win{background:#16a34a!important}
input,button{padding:6px;margin:4px}
</style>
</head>

<body>

<h2>‚ùå‚≠ï C·ªú CARO ONLINE</h2>

<div id="login">
  <input id="name" placeholder="T√™n ki·ªán t∆∞·ªõng">
  <button onclick="joinGame()">V√†o ph√≤ng</button>
</div>

<p id="info"></p>
<div id="board"></div>
<p id="status"></p>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6"
});
const db = firebase.database();
/* =================== */

const SIZE = 15;
const WIN = 5;
const GAME_TIME = 15 * 60 * 1000;

// room t·ª´ link
let room = location.hash.replace("#","");
if(!room){
  room = Math.random().toString(36).slice(2,7);
  location.hash = room;
}

let uid = localStorage.uid || (localStorage.uid = Math.random().toString(36).slice(2));
let myRole = null;
let myName = "";
let cells = Array(SIZE*SIZE).fill("");

// t·∫°o b√†n
const boardDiv = document.getElementById("board");
boardDiv.style.gridTemplateColumns = `repeat(${SIZE},26px)`;
for(let i=0;i<cells.length;i++){
  const d=document.createElement("div");
  d.className="cell";
  d.onclick=()=>play(i);
  boardDiv.appendChild(d);
}

function joinGame(){
  myName = document.getElementById("name").value.trim();
  if(!myName) return alert("Nh·∫≠p t√™n ki·ªán t∆∞·ªõng");

  document.getElementById("login").style.display="none";

  db.ref("rooms/"+room).transaction(data=>{
    if(!data){
      data = {
        board: cells,
        turn: "X",
        startTime: Date.now(),
        players: {}
      };
    }

    if(!data.players.X){
      data.players.X={id:uid,name:myName};
      myRole="X";
    }else if(!data.players.O){
      data.players.O={id:uid,name:myName};
      myRole="O";
    }

    return data;
  });

  listen();
}

function listen(){
  db.ref("rooms/"+room).on("value",snap=>{
    const d=snap.val();
    if(!d) return;

    cells=d.board||cells;
    cells.forEach((v,i)=>boardDiv.children[i].innerText=v||"");

    document.getElementById("info").innerText =
      `‚ùå ${d.players.X?.name||"..."}  vs  ‚≠ï ${d.players.O?.name||"..."}`;

    if(Date.now()-d.startTime>GAME_TIME){
      resetGame();
    }

    if(d.winner){
      document.getElementById("status").innerText=`üéâ ${d.winner} th·∫Øng`;
      return;
    }

    document.getElementById("status").innerText =
      myRole===d.turn ? "L∆∞·ª£t c·ªßa b·∫°n" : "Ch·ªù ƒë·ªëi th·ªß";
  });
}

function play(i){
  db.ref("rooms/"+room).once("value",snap=>{
    const d=snap.val();
    if(!d || d.turn!==myRole || cells[i]) return;

    cells[i]=myRole;
    const win = checkWin(i,myRole);

    db.ref("rooms/"+room).update({
      board: cells,
      turn: myRole==="X"?"O":"X",
      winner: win?myRole:null
    });
  });
}

function checkWin(pos,val){
  const r=Math.floor(pos/SIZE), c=pos%SIZE;
  const dirs=[[1,0],[0,1],[1,1],[1,-1]];
  for(let [dr,dc] of dirs){
    let cnt=1;
    for(let k=1;k<WIN;k++){
      const i=(r+dr*k)*SIZE+c+dc*k;
      if(cells[i]===val) cnt++; else break;
    }
    for(let k=1;k<WIN;k++){
      const i=(r-dr*k)*SIZE+c-dc*k;
      if(cells[i]===val) cnt++; else break;
    }
    if(cnt>=WIN) return true;
  }
  return false;
}

function resetGame(){
  db.ref("rooms/"+room).update({
    board:Array(SIZE*SIZE).fill(""),
    turn:"X",
    startTime:Date.now(),
    winner:null
  });
}
</script>

</body>
</html>
