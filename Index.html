<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù vua Online</title>

<link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/www/css/chessboard.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://unpkg.com/chessboardjs@1.0.0/www/js/chessboard.js"></script>

<!-- Firebase COMPAT (B·∫ÆT BU·ªòC) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family: Arial;
  background:#0f172a;
  color:white;
  text-align:center;
}
#board{
  width:320px;
  margin:20px auto;
}
input,button{
  padding:8px 10px;
  border-radius:6px;
  border:none;
  margin:5px;
}
button{
  cursor:pointer;
  background:#2563eb;
  color:white;
}
</style>
</head>

<body>

<h2>‚ôüÔ∏è C·ªù vua Online</h2>

<div>
  <input id="room" placeholder="M√£ ph√≤ng">
  <button onclick="createRoom()">T·∫°o ph√≤ng</button>
  <button onclick="joinRoom()">V√†o ph√≤ng</button>
</div>

<div id="info"></div>
<div id="board"></div>

<button onclick="resetGame()">Reset (Host)</button>

<script>
/* üî• FIREBASE CONFIG ‚Äì D√ôNG CONFIG C·ª¶A B·∫†N */
const firebaseConfig = {
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  authDomain: "noitu-7dca6.firebaseapp.com",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6",
  storageBucket: "noitu-7dca6.firebasestorage.app",
  messagingSenderId: "253854569418",
  appId: "1:253854569418:web:105e8e3edfdd9baafff533"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
/* ---------------------------------- */

let game = new Chess();
let board = null;
let roomId = "";
let myColor = "";
let isHost = false;

/* T·∫†O B√ÄN C·ªú SAU KHI LOAD */
window.onload = () => {
  board = Chessboard('board', {
    draggable: true,
    position: 'start',
    onDrop: onDrop
  });
};

/* T·∫†O PH√íNG */
function createRoom(){
  roomId = Math.random().toString(36).substr(2,5);
  document.getElementById("room").value = roomId;

  isHost = true;
  myColor = "w";

  db.ref("rooms/" + roomId).set({
    fen: game.fen(),
    turn: "w"
  });

  listenRoom();
  updateInfo();
}

/* V√ÄO PH√íNG */
function joinRoom(){
  roomId = document.getElementById("room").value.trim();
  if(!roomId) return alert("Nh·∫≠p m√£ ph√≤ng");

  myColor = "b";
  listenRoom();
  updateInfo();
}

/* HI·ªÇN TH√îNG TIN */
function updateInfo(){
  document.getElementById("info").innerText =
    `Ph√≤ng: ${roomId} | B·∫°n: ${myColor === "w" ? "Tr·∫Øng" : "ƒêen"}`;
}

/* L·∫ÆNG NGHE GAME */
function listenRoom(){
  db.ref("rooms/" + roomId).on("value", snap=>{
    const data = snap.val();
    if(!data) return;

    game.load(data.fen);
    board.position(game.fen());
  });
}

/* K√âO TH·∫¢ */
function onDrop(source, target){
  if(game.turn() !== myColor) return "snapback";

  const move = game.move({
    from: source,
    to: target,
    promotion: 'q'
  });

  if(!move) return "snapback";

  db.ref("rooms/" + roomId).update({
    fen: game.fen(),
    turn: game.turn()
  });
}

/* RESET GAME */
function resetGame(){
  if(!isHost) return alert("Ch·ªâ host ƒë∆∞·ª£c reset");

  game.reset();
  db.ref("rooms/" + roomId).set({
    fen: game.fen(),
    turn: "w"
  });
}
</script>

</body>
</html>
