<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>C·ªù Caro Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  text-align:center;
}
#board{
  display:grid;
  gap:4px;
  justify-content:center;
  margin:20px auto;
}
.cell{
  width:28px;
  height:28px;
  background:#1e293b;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:18px;
}
.win{ background:#16a34a !important }
input,button{
  padding:6px;
  margin:4px;
}
#panel{ margin-top:10px }
</style>
</head>

<body>

<h2>‚ùå‚≠ï C·ªú CARO ONLINE</h2>

<div id="login">
  <input id="name" placeholder="T√™n ki·ªán t∆∞·ªõng">
  <input id="room" placeholder="M√£ ph√≤ng (vd 1111)">
  <button onclick="joinRoom()">V√†o ph√≤ng</button>
</div>

<div id="panel" style="display:none">
  <p id="info"></p>
  <p id="turn"></p>
</div>

<div id="board"></div>
<p id="status"></p>

<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6"
});
const db = firebase.database();
/* =========================== */

/* ===== C·∫§U H√åNH GAME ===== */
const SIZE = 15;
const WIN = 5;
const TURN_TIME = 15000; // 15 gi√¢y
/* ======================== */

let roomId = "";
let myRole = "spectator";
let myName = "";
let cells = Array(SIZE*SIZE).fill("");
let uid = localStorage.uid || (localStorage.uid = Math.random().toString(36).slice(2));

/* ===== T·∫†O B√ÄN ===== */
const boardDiv = document.getElementById("board");
boardDiv.style.gridTemplateColumns = `repeat(${SIZE},28px)`;
for(let i=0;i<cells.length;i++){
  const d = document.createElement("div");
  d.className = "cell";
  d.onclick = ()=> play(i);
  boardDiv.appendChild(d);
}

/* ===== V√ÄO PH√íNG ===== */
function joinRoom(){
  myName = document.getElementById("name").value.trim();
  roomId = document.getElementById("room").value.trim();
  if(!myName || !roomId) return alert("Nh·∫≠p ƒë·ªß t√™n & m√£ ph√≤ng");

  document.getElementById("login").style.display="none";
  document.getElementById("panel").style.display="block";

  db.ref("rooms/"+roomId).transaction(room=>{
    if(!room){
      room = {
        board: cells,
        turn: "X",
        turnStart: firebase.database.ServerValue.TIMESTAMP,
        players: {}
      };
    }

    if(!room.players.X){
      room.players.X = {id:uid,name:myName};
      myRole = "X";
    }else if(!room.players.O){
      room.players.O = {id:uid,name:myName};
      myRole = "O";
    }else{
      myRole = "spectator";
    }
    return room;
  });

  listen();
}

/* ===== L·∫ÆNG NGHE ===== */
function listen(){
  db.ref("rooms/"+roomId).on("value",snap=>{
    const d = snap.val();
    if(!d) return;

    // sync b√†n
    cells = d.board || cells;
    cells.forEach((v,i)=> boardDiv.children[i].innerText = v || "");

    // t√™n
    document.getElementById("info").innerText =
      `‚ùå ${d.players.X?.name||"..."}  vs  ‚≠ï ${d.players.O?.name||"..."}`;

    // ki·ªÉm tra h·∫øt l∆∞·ª£t
    if(Date.now() - d.turnStart > TURN_TIME){
      forceSwitchTurn(d.turn);
      return;
    }

    // tr·∫°ng th√°i
    if(d.winner){
      document.getElementById("status").innerText =
        `üéâ ${d.winner==="X"?d.players.X.name:d.players.O.name} TH·∫ÆNG`;
      return;
    }

    document.getElementById("turn").innerText =
      d.turn===myRole ? "üëâ L∆Ø·ª¢T C·ª¶A B·∫†N (15s)" : "‚è≥ ƒê·ª£i ƒë·ªëi th·ªß";
  });
}

/* ===== ƒê√ÅNH C·ªú ===== */
function play(i){
  if(myRole==="spectator") return;

  db.ref("rooms/"+roomId).once("value",snap=>{
    const d = snap.val();
    if(!d || d.turn!==myRole) return;
    if(d.board[i]) return;

    d.board[i]=myRole;

    const win = checkWin(i,myRole,d.board);

    db.ref("rooms/"+roomId).update({
      board:d.board,
      turn: myRole==="X"?"O":"X",
      turnStart: firebase.database.ServerValue.TIMESTAMP,
      winner: win?myRole:null
    });
  });
}

/* ===== H·∫æT 15 GI√ÇY ===== */
function forceSwitchTurn(current){
  db.ref("rooms/"+roomId).update({
    turn: current==="X"?"O":"X",
    turnStart: firebase.database.ServerValue.TIMESTAMP
  });
}

/* ===== CHECK TH·∫ÆNG ===== */
function checkWin(pos,val,board){
  const r=Math.floor(pos/SIZE), c=pos%SIZE;
  const dirs=[[1,0],[0,1],[1,1],[1,-1]];
  for(let [dr,dc] of dirs){
    let cnt=1;
    for(let k=1;k<WIN;k++){
      const i=(r+dr*k)*SIZE+c+dc*k;
      if(board[i]===val) cnt++; else break;
    }
    for(let k=1;k<WIN;k++){
      const i=(r-dr*k)*SIZE+c-dc*k;
      if(board[i]===val) cnt++; else break;
    }
    if(cnt>=WIN) return true;
  }
  return false;
}
</script>

</body>
</html>
